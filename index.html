<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- Nous chargeons les fichiers CDN de Leaflet. Le CSS AVANT le JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
        integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin="" />
    <link rel="stylesheet" href="style.css">
    <style type="text/css">

    </style>
    <title>Carte</title>
</head>

<body>
    <div class="miam">
        <div class="miam__restau">
            <ul>
                <li onclick="restau(50.52969, 1.349903)">Kebab tah les anciens</li>
                <li onclick="restau(33.52969, 9.349903)">Tacos tah les anciens</li>
                <li onclick="restau(25.52969, 3.349903)">Grec tah les anciens</li>
            </ul>
        </div>
        <div id="map" class="miam__map">
            <!-- Ici s'affichera la carte -->
        </div>
        <div class="miam__restau">
            <ul>
                <li>Nicolas</li>
                <li>alex</li>
                <li>Grec tah les anciens</li>
            </ul>
        </div>
    </div>

    <!-- Fichiers Javascript -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
        integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
        crossorigin=""></script>
    <script type="text/javascript">



        // icones
        var IconRestaurant = L.icon({
            iconUrl: '/img/restaurant.png',

            iconSize: [35, 35], // size of the icon
            popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
        });

        var IconFinish = L.icon({
            iconUrl: '/img/finish.png',

            iconSize: [35, 35], // size of the icon
            popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
        });

        var IconUsers = L.icon({
            iconUrl: '/img/users.png',

            iconSize: [35, 35], // size of the icon
            popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
        });


        let restaurant = [43.852969, 3.349903];
        function restau(lati, lngi) {

            restaurant = [lati, lngi]
            macarte.remove();
            initMap();

        }

        let currentUser = [
            {
                "name": "Nico",
                "depart": [43.852969, 3.349903],
                "restaurant": restaurant,
                "time": 0
            },
        ]


        let nextUsers = [
            {
                "name": "Alex",
                "depart": [50.52969, 5.349903],
                "restaurant": [56.52969, 8.349903],
                "time": 0
            },
            {
                "name": "Chachat",
                "depart": [45.52969, 4.349903],
                "restaurant": [48.52969, 4.349903],
                "time": 0
            },
        ]

        let allUsers = [];

        currentUser.forEach(element => {
            allUsers.push(element)
        })
        nextUsers.forEach(element => {
            allUsers.push(element)
        })

        console.log(allUsers)




        let finish = [48.8512, 2.349903]
        let lat = 48.852969
        let lng = 2.349903

        // Fonction d'initialisation de la carte
        function initMap() {
            var polylines = [];

            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView([lat, lng], 5);
            // point d'arrivé
            let marker = L.marker([lat, lng], {
                draggable: true,
                autoPan: true,
                icon: IconFinish
            }).addTo(macarte);


            marker.on('dragend', function (e) {
                lat = marker.getLatLng().lat;
                lng = marker.getLatLng().lng;
                finish = [marker.getLatLng().lat, marker.getLatLng().lng]


                polylines.forEach(element => {
                    macarte.removeLayer(element)
                })
                line()
                algoDistance()
            });

            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © OpenStreetMap/ODbL - rendu OSM France',
                minZoom: 1,
                maxZoom: 20
            }).addTo(macarte);


            line()
            function line() {
                nextUsers.forEach(e => {

                    polylines.push(L.polyline([[e.depart[0], e.depart[1]], [e.restaurant[0], e.restaurant[1]], [lat, lng]], { color: 'red' }).addTo(macarte))

                })

                currentUser.forEach(e => {

                    console.log(restaurant);
                    if (restaurant[0] === 43.852969) {
                        polylines.push(L.polyline([[e.depart[0], e.depart[1]], [restaurant[0], restaurant[1]], [lat, lng]], { color: 'red' }).addTo(macarte))
                    } else {
                        polylines.push(L.polyline([[e.depart[0], e.depart[1]], [restaurant[0], restaurant[1]], [lat, lng]], { color: 'red' }).addTo(macarte))
                    }

                })

            }


            // Nous parcourons la liste des villes
            nextUsers.forEach(e => {
                let marker = L.marker([e.depart[0], e.depart[1]], { icon: IconUsers }).addTo(macarte).bindTooltip(e.name + '<br/>',
                    {
                        permanent: true,
                        direction: 'right'
                    });
                let markerR = L.marker([e.restaurant[0], e.restaurant[1]], { icon: IconRestaurant }).addTo(macarte).bindPopup(e.name);
            });

            currentUser.forEach(e => {
                let marker = L.marker([e.depart[0], e.depart[1]], { icon: IconUsers }).addTo(macarte).bindTooltip(e.name + '<br/>',
                    {
                        permanent: true,
                        direction: 'right'
                    });;
                if (restaurant[0] !== 43.852969) {
                    let markerR = L.marker([restaurant[0], restaurant[1]], { icon: IconRestaurant }).addTo(macarte).bindPopup(e.name);
                } else {

                }
            })

        }



        function algoDistance() {
            const meetTime = new Date();
            meetTime.setHours(13)
            meetTime.setMinutes(0);
            meetTime.setSeconds(0)
            const vitesse = 5;

            function getDistance(user, finish) {
                return macarte.distance(user, finish)
            }

            function getDistanceUserFinish(user) {
                let userPos = user.depart;
                let restoPos = user.restaurant;
                let userRestaurant = getDistance(userPos, restoPos)
                let restoFinish = getDistance(restoPos, finish);
                let totalD = userRestaurant + restoFinish;
                return (totalD / 1000)
            }

            function getTime(distance) {
                let time = (distance / vitesse) * 3600
                return time
            }

            function getTimeToLeave(time, meetTime) {
                let newDate = new Date(meetTime.getTime() - time * 1000)
                return newDate
            }

            function timeUser() {
                allUsers.forEach((user) => {
                    let distance = getDistanceUserFinish(user);
                    let time = getTime(distance);
                    let departTime = getTimeToLeave(time, meetTime)
                    console.log("User " + (allUsers.indexOf(user) + 1) + " doit partir à " + departTime)
                })
            }

            timeUser()

        }

        window.onload = function () {
            // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
            initMap();
            algoDistance()
        };
    </script>
</body>

</htm